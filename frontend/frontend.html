<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Germany Flood Risk Monitor</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            color: #2c3e50;
        }
        
        /* Layout */
        .dashboard {
            display: flex;
            height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 320px;
            background: white;
            border-right: 1px solid #e1e8ed;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e1e8ed;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }
        
        .sidebar-header h1 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .sidebar-header p {
            font-size: 12px;
            opacity: 0.9;
        }
        
        /* Search */
        .search-container {
            padding: 16px;
            border-bottom: 1px solid #e1e8ed;
        }
        
        .search-box {
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: #f8f9fa;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #3498db;
            background: white;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-top: 4px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .search-result-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background: #3498db;
            color: white;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .reset-btn {
            width: 100%;
            margin-top: 8px;
            padding: 8px 12px;
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
            display: none;
        }
        
        .reset-btn:hover {
            background: #7f8c8d;
        }
        
        /* Risk Overview */
        .risk-overview {
            padding: 16px;
            border-bottom: 1px solid #e1e8ed;
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .risk-cards {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .risk-card {
            padding: 12px;
            border-radius: 8px;
            background: #f8f9fa;
            border-left: 4px solid;
        }
        
        .risk-card.high {
            border-left-color: #e74c3c;
            background: #fdedec;
        }
        
        .risk-card.medium {
            border-left-color: #f39c12;
            background: #fef5e7;
        }
        
        .risk-card.low {
            border-left-color: #f1c40f;
            background: #fef9e7;
        }
        
        .risk-card.very-low {
            border-left-color: #27ae60;
            background: #eafaf1;
        }
        
        .risk-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .risk-title {
            font-size: 13px;
            font-weight: 600;
        }
        
        .risk-count {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .risk-dots {
            display: flex;
            gap: 2px;
            margin-top: 4px;
        }
        
        .risk-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        /* Filters */
        .filters {
            padding: 16px;
            border-bottom: 1px solid #e1e8ed;
        }
        
        .filter-group {
            margin-bottom: 16px;
        }
        
        .filter-options {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .filter-option {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            cursor: pointer;
        }
        
        .filter-option input {
            margin: 0;
        }
        
        /* Station List */
        .station-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        
        .station-item {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid;
        }
        
        .station-item:hover {
            background: #e8f4fd;
            transform: translateX(2px);
        }
        
        .station-item.high { border-left-color: #e74c3c; }
        .station-item.medium { border-left-color: #f39c12; }
        .station-item.low { border-left-color: #f1c40f; }
        .station-item.very-low { border-left-color: #27ae60; }
        
        .station-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .station-name {
            font-size: 13px;
            font-weight: 600;
        }
        
        .station-risk {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            color: white;
            font-weight: 500;
        }
        
        .station-risk.high { background: #e74c3c; }
        .station-risk.medium { background: #f39c12; }
        .station-risk.low { background: #f1c40f; }
        .station-risk.very-low { background: #27ae60; }
        
        .station-details {
            font-size: 11px;
            color: #7f8c8d;
        }
        
        /* Map */
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Header -->
            <div class="sidebar-header">
                <h1>🌊 Germany Flood Risk Monitor</h1>
                <p>Real-time flood risk assessment</p>
            </div>
            
            <!-- Search -->
            <div class="search-container">
                <div class="search-box">
                    <input type="text" id="citySearch" placeholder="Search for a German city...">
                    <div id="searchResults" class="search-results"></div>
                </div>
                <button id="resetSearch" class="reset-btn">Show All Stations</button>
            </div>
            
            <!-- Risk Overview -->
            <div class="risk-overview">
                <div class="section-title">🚨 Risk Overview</div>
                <div class="risk-cards">
                    <div class="risk-card high">
                        <div class="risk-header">
                            <div class="risk-title">High Risk</div>
                            <div class="risk-count" id="highRiskCount">0 stations</div>
                        </div>
                        <div class="risk-dots" id="highRiskDots"></div>
                    </div>
                    <div class="risk-card medium">
                        <div class="risk-header">
                            <div class="risk-title">Medium Risk</div>
                            <div class="risk-count" id="mediumRiskCount">0 stations</div>
                        </div>
                        <div class="risk-dots" id="mediumRiskDots"></div>
                    </div>
                    <div class="risk-card low">
                        <div class="risk-header">
                            <div class="risk-title">Low Risk</div>
                            <div class="risk-count" id="lowRiskCount">0 stations</div>
                        </div>
                        <div class="risk-dots" id="lowRiskDots"></div>
                    </div>
                    <div class="risk-card very-low">
                        <div class="risk-header">
                            <div class="risk-title">Very Low Risk</div>
                            <div class="risk-count" id="veryLowRiskCount">0 stations</div>
                        </div>
                        <div class="risk-dots" id="veryLowRiskDots"></div>
                    </div>
                </div>
            </div>
            
            <!-- Filters -->
            <div class="filters">
                <div class="filter-group">
                    <div class="section-title">🔧 Filters</div>
                    <div class="filter-options">
                        <label class="filter-option">
                            <input type="checkbox" checked data-risk="high"> High Risk
                        </label>
                        <label class="filter-option">
                            <input type="checkbox" checked data-risk="medium"> Medium Risk
                        </label>
                        <label class="filter-option">
                            <input type="checkbox" checked data-risk="low"> Low Risk
                        </label>
                        <label class="filter-option">
                            <input type="checkbox" checked data-risk="very-low"> Very Low Risk
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Station List -->
            <div class="station-list">
                <div class="section-title">📋 Stations (<span id="totalStations">0</span>)</div>
                <div id="stationList">
                    <!-- Stations will be populated by JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- Alarm Banner -->
<div id="alarmBanner" style="
    display: none;
    position: absolute;
    top: 0;
    left: 320px;
    right: 0;
    z-index: 1000;
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
    font-weight: 600;
    text-align: center;
    padding: 15px;
    font-size: 16px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
">
    ⚠️ HIGH FLOOD RISK DETECTED - Monitor stations closely!
</div>

<!-- Map -->
<div class="map-container">
    <div id="map"></div>
    <!-- Legend -->
<div id="legend" style="
    position: absolute;
    bottom: 20px;
    right: 20px;
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    z-index: 1000;
    font-size: 12px;
    min-width: 150px;
">
    <div style="font-weight: 600; margin-bottom: 8px; color: #2c3e50;">🌊 Flood Risk Legend</div>
    <div style="display: flex; align-items: center; margin-bottom: 4px;">
        <div style="width: 12px; height: 12px; border-radius: 50%; background: #e74c3c; margin-right: 8px;"></div>
        <span>High Risk</span>
    </div>
    <div style="display: flex; align-items: center; margin-bottom: 4px;">
        <div style="width: 12px; height: 12px; border-radius: 50%; background: #f39c12; margin-right: 8px;"></div>
        <span>Medium Risk</span>
    </div>
    <div style="display: flex; align-items: center; margin-bottom: 4px;">
        <div style="width: 12px; height: 12px; border-radius: 50%; background: #f1c40f; margin-right: 8px;"></div>
        <span>Low Risk</span>
    </div>
    <div style="display: flex; align-items: center; margin-bottom: 4px;">
        <div style="width: 12px; height: 12px; border-radius: 50%; background: #27ae60; margin-right: 8px;"></div>
        <span>Very Low Risk</span>
    </div>
</div>
</div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // German cities database
// German cities database
const germanCities = [
    { name: "Berlin", lat: 52.5200, lon: 13.4050, type: "capital" },
    { name: "Hamburg", lat: 53.5511, lon: 9.9937, type: "city" },
    { name: "Munich", lat: 48.1351, lon: 11.5820, type: "city" },
    { name: "Cologne", lat: 50.9375, lon: 6.9603, type: "city" },
    { name: "Frankfurt", lat: 50.1109, lon: 8.6821, type: "city" },
    { name: "Stuttgart", lat: 48.7758, lon: 9.1829, type: "city" },
    { name: "Düsseldorf", lat: 51.2277, lon: 6.7735, type: "city" },
    { name: "Dortmund", lat: 51.5136, lon: 7.4653, type: "city" },
    { name: "Essen", lat: 51.4556, lon: 7.0116, type: "city" },
    { name: "Leipzig", lat: 51.3397, lon: 12.3731, type: "city" },
    { name: "Bremen", lat: 53.0793, lon: 8.8017, type: "city" },
    { name: "Dresden", lat: 51.0504, lon: 13.7373, type: "city" },
    { name: "Hannover", lat: 52.3759, lon: 9.7320, type: "city" },
    { name: "Nuremberg", lat: 49.4521, lon: 11.0767, type: "city" },
    { name: "Duisburg", lat: 51.4344, lon: 6.7623, type: "city" },
    { name: "Saarbrücken", lat: 49.2402, lon: 6.9969, type: "city" },
    { name: "Bochum", lat: 51.4818, lon: 7.2162, type: "city" },
    { name: "Wuppertal", lat: 51.2562, lon: 7.1508, type: "city" },
    { name: "Bielefeld", lat: 52.0200, lon: 8.5330, type: "city" },
    { name: "Bonn", lat: 50.7374, lon: 7.0982, type: "city" },
    { name: "Münster", lat: 51.9607, lon: 7.6261, type: "city" },
    { name: "Karlsruhe", lat: 49.0069, lon: 8.4037, type: "city" },
    { name: "Mannheim", lat: 49.4875, lon: 8.4660, type: "city" },
    { name: "Augsburg", lat: 48.3705, lon: 10.8978, type: "city" },
    { name: "Wiesbaden", lat: 50.0820, lon: 8.2410, type: "city" },
    { name: "Gelsenkirchen", lat: 51.5177, lon: 7.0857, type: "city" },
    { name: "Mönchengladbach", lat: 51.1805, lon: 6.4428, type: "city" },
    { name: "Braunschweig", lat: 52.2689, lon: 10.5268, type: "city" },
    { name: "Kiel", lat: 54.3233, lon: 10.1228, type: "city" },
    { name: "Chemnitz", lat: 50.8328, lon: 12.9209, type: "city" },
    { name: "Aachen", lat: 50.7753, lon: 6.0839, type: "city" },
    { name: "Halle", lat: 51.4820, lon: 11.9690, type: "city" },
    { name: "Magdeburg", lat: 52.1205, lon: 11.6276, type: "city" },
    { name: "Freiburg", lat: 47.9990, lon: 7.8421, type: "city" },
    { name: "Krefeld", lat: 51.3388, lon: 6.5853, type: "city" },
    { name: "Lübeck", lat: 53.8655, lon: 10.6866, type: "city" },
    { name: "Oberhausen", lat: 51.4967, lon: 6.8519, type: "city" },
    { name: "Erfurt", lat: 50.9848, lon: 11.0299, type: "city" },
    { name: "Mainz", lat: 50.0012, lon: 8.2763, type: "city" },
    { name: "Rostock", lat: 54.0924, lon: 12.0991, type: "city" },
    { name: "Kassel", lat: 51.3127, lon: 9.4797, type: "city" },
    { name: "Hagen", lat: 51.3671, lon: 7.4633, type: "city" },
    { name: "Hamm", lat: 51.6739, lon: 7.8160, type: "city" },
    { name: "Saarland", lat: 49.3964, lon: 6.9969, type: "region" },
    { name: "Potsdam", lat: 52.3906, lon: 13.0645, type: "city" },
    { name: "Ludwigshafen", lat: 49.4812, lon: 8.4463, type: "city" },
    { name: "Oldenburg", lat: 53.1435, lon: 8.2146, type: "city" },
    { name: "Leverkusen", lat: 51.0303, lon: 6.9843, type: "city" },
    { name: "Osnabrück", lat: 52.2799, lon: 8.0472, type: "city" },
    { name: "Solingen", lat: 51.1702, lon: 7.0835, type: "city" },
    { name: "Heidelberg", lat: 49.3988, lon: 8.6724, type: "city" },
    { name: "Herne", lat: 51.5369, lon: 7.2009, type: "city" },
    { name: "Neuss", lat: 51.2042, lon: 6.6876, type: "city" },
    { name: "Darmstadt", lat: 49.8728, lon: 8.6512, type: "city" },
    { name: "Paderborn", lat: 51.7189, lon: 8.7575, type: "city" },
    { name: "Regensburg", lat: 49.0134, lon: 12.1016, type: "city" },
    { name: "Ingolstadt", lat: 48.7638, lon: 11.4257, type: "city" },
    { name: "Würzburg", lat: 49.7913, lon: 9.9534, type: "city" },
    { name: "Fürth", lat: 49.4771, lon: 10.9887, type: "city" },
    { name: "Wolfsburg", lat: 52.4226, lon: 10.7865, type: "city" },
    { name: "Ulm", lat: 48.4011, lon: 9.9876, type: "city" },
    { name: "Heilbronn", lat: 49.1427, lon: 9.2109, type: "city" },
    { name: "Pforzheim", lat: 48.8922, lon: 8.6946, type: "city" },
    { name: "Göttingen", lat: 51.5413, lon: 9.9158, type: "city" },
    { name: "Bottrop", lat: 51.5270, lon: 6.9246, type: "city" },
    { name: "Trier", lat: 49.7499, lon: 6.6373, type: "city" },
    { name: "Recklinghausen", lat: 51.6141, lon: 7.1979, type: "city" },
    { name: "Reutlingen", lat: 48.4914, lon: 9.2115, type: "city" },
    { name: "Bremerhaven", lat: 53.5396, lon: 8.5809, type: "city" },
    { name: "Koblenz", lat: 50.3569, lon: 7.5890, type: "city" },
    { name: "Bergisch Gladbach", lat: 50.9916, lon: 7.1367, type: "city" },
    { name: "Jena", lat: 50.9271, lon: 11.5892, type: "city" },
    { name: "Remscheid", lat: 51.1787, lon: 7.1897, type: "city" },
    { name: "Erlangen", lat: 49.5960, lon: 11.0043, type: "city" },
    { name: "Moers", lat: 51.4516, lon: 6.6408, type: "city" },
    { name: "Siegen", lat: 50.8837, lon: 8.0170, type: "city" },
    { name: "Hildesheim", lat: 52.1548, lon: 9.9578, type: "city" },
    { name: "Salzgitter", lat: 52.1500, lon: 10.3333, type: "city" }
];

        // Initialize the map
        var map = L.map('map').setView([51.1657, 10.4515], 6);
        var stationsLayer;
        var allStations = [];
        var stationMarkers = {};

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // DOM Elements
        const searchInput = document.getElementById('citySearch');
        const searchResults = document.getElementById('searchResults');
        const resetButton = document.getElementById('resetSearch');

        // Search functionality
        searchInput.addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            searchResults.innerHTML = '';
            
            if (query.length < 2) {
                searchResults.style.display = 'none';
                resetButton.style.display = query ? 'block' : 'none';
                return;
            }
            
            const matches = germanCities.filter(city => 
                city.name.toLowerCase().includes(query)
            );
            
            if (matches.length > 0) {
                matches.forEach(city => {
                    const div = document.createElement('div');
                    div.className = 'search-result-item';
                    div.textContent = city.name;
                    div.onclick = () => zoomToCity(city);
                    searchResults.appendChild(div);
                });
                searchResults.style.display = 'block';
                resetButton.style.display = 'block';
            } else {
                searchResults.style.display = 'none';
                resetButton.style.display = 'block';
            }
        });

        // Enter key support for search
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const query = this.value.toLowerCase();
                const match = germanCities.find(city => 
                    city.name.toLowerCase() === query
                );
                if (match) {
                    zoomToCity(match);
                } else if (query.length > 0) {
                    alert('City not found. Please select from the dropdown.');
                }
            }
        });

        // Reset functionality
        resetButton.addEventListener('click', function() {
            searchInput.value = '';
            resetToAllStations();
            resetButton.style.display = 'none';
            searchResults.style.display = 'none';
        });

        // Close search results when clicking outside
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.style.display = 'none';
            }
        });

        function zoomToCity(city) {
            console.log('Zooming to:', city.name);
            
            // Zoom to the city
            map.setView([city.lat, city.lon], 10);
            
            // Clear previous city marker and radius
            if (window.cityMarker) {
                map.removeLayer(window.cityMarker);
            }
            if (window.cityRadius) {
                map.removeLayer(window.cityRadius);
            }
            
            // Add blue radius circle (20km)
            window.cityRadius = L.circle([city.lat, city.lon], {
                color: '#3498db',
                fillColor: '#3498db',
                fillOpacity: 0.1,
                radius: 20000 // 20km in meters
            }).addTo(map);
            
            // Add marker for the searched city
            window.cityMarker = L.marker([city.lat, city.lon])
                .addTo(map);
            
            // Find stations within 20km radius and create summary
            const nearbyStations = findStationsInRadius(city.lat, city.lon, 20000);
            const summaryContent = createAreaSummary(city.name, nearbyStations);
            
            window.cityMarker.bindPopup(summaryContent).openPopup();
            
            // Hide search results
            searchResults.style.display = 'none';
            searchInput.value = city.name;
            
            // Update sidebar with area stations
            updateSidebarWithAreaStations(nearbyStations, city.name);
        }

        function findStationsInRadius(lat, lon, radiusMeters) {
            if (allStations.length === 0) return [];
            
            return allStations.filter(station => {
                const coords = station.geometry.coordinates;
                const distance = map.distance([lat, lon], [coords[1], coords[0]]);
                return distance <= radiusMeters;
            });
        }

        function createAreaSummary(cityName, stations) {
            let summaryContent = `
                <div style="min-width: 250px;">
                    <h3 style="margin: 0 0 10px 0; color: #2c3e50;">🌊 ${cityName} Area</h3>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
                        <strong>Flood Risk Summary</strong><br>
                        Stations in 20km radius: <strong>${stations.length}</strong>
            `;
            
            if (stations.length > 0) {
                const riskCounts = {};
                stations.forEach(station => {
                    const risk = station.properties.flood_risk_category || 'Unknown';
                    riskCounts[risk] = (riskCounts[risk] || 0) + 1;
                });
                
                summaryContent += `<div style="margin-top: 8px;">`;
                Object.entries(riskCounts).forEach(([risk, count]) => {
                    const color = getRiskColor(risk);
                    summaryContent += `
                        <div style="display: flex; align-items: center; margin-bottom: 4px;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: ${color}; margin-right: 8px;"></div>
                            ${risk}: ${count} stations
                        </div>
                    `;
                });
                summaryContent += `</div>`;
            } else {
                summaryContent += `<div style="margin-top: 8px; color: #7f8c8d;">
                    No flood monitoring stations in this area.
                </div>`;
            }
            
            summaryContent += `
                    </div>
                    <div style="font-size: 11px; color: #7f8c8d;">
                        💡 Blue circle shows 20km search radius
                    </div>
                </div>
            `;
            
            return summaryContent;
        }

        function updateSidebarWithAreaStations(stations, cityName) {
            const stationList = document.getElementById('stationList');
            
            // Update header to show we're filtering by area
            document.querySelector('.station-list .section-title').innerHTML = 
                `📋 ${cityName} Area (${stations.length} stations)`;
            
            // Clear current list
            stationList.innerHTML = '';
            
            if (stations.length === 0) {
                stationList.innerHTML = `
                    <div style="text-align: center; color: #7f8c8d; padding: 20px;">
                        No stations found in ${cityName} area
                    </div>
                `;
                return;
            }
            
            // Populate with area stations
            populateStationList(stations);
        }

        function resetToAllStations() {
            const stationList = document.getElementById('stationList');
            
            document.querySelector('.station-list .section-title').innerHTML = 
                `📋 Stations (${allStations.length})`;
            
            // Clear any city visualization
            if (window.cityRadius) {
                map.removeLayer(window.cityRadius);
                window.cityRadius = null;
            }
            if (window.cityMarker) {
                map.removeLayer(window.cityMarker);
                window.cityMarker = null;
            }
            
            // Repopulate with all stations
            populateStationList(allStations);
        }

        // Load and process GeoJSON data
        fetch('germany_waterlevels_with_forecast.geojson')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(geojsonData => {
    console.log('Loaded GeoJSON data:', geojsonData);
    allStations = geojsonData.features;
    
    // 🔴 CHECK FOR HIGH RISK STATIONS AND SHOW ALARM
    const highRiskStations = allStations.filter(station => {
        const risk = station.properties.flood_risk_category;
        return risk === 'High' || risk === 'Extreme';
    });
    
    if (highRiskStations.length > 0) {
        const alarmBanner = document.getElementById('alarmBanner');
        alarmBanner.style.display = 'block';
        alarmBanner.innerHTML = `⚠️ HIGH FLOOD RISK DETECTED - ${highRiskStations.length} station(s) require immediate attention!`;
        
        // Auto-hide after 10 seconds
        setTimeout(() => {
            alarmBanner.style.display = 'none';
        }, 10000);
        
        // Add click to close functionality
        alarmBanner.addEventListener('click', function() {
            this.style.display = 'none';
        });
    }
    
    // Create stations layer (your existing code continues...)
    stationsLayer = L.geoJSON(geojsonData, {
                    pointToLayer: function(feature, latlng) {
    const riskCategory = feature.properties.flood_risk_category || 'Unknown';
    const risk = riskCategory.toLowerCase().replace(' ', '-');
    
    // Make high risk stations more prominent
    const isHighRisk = riskCategory === 'High' || riskCategory === 'Extreme';
    
    const marker = L.circleMarker(latlng, {
        radius: isHighRisk ? 12 : getRiskRadius(riskCategory), // Larger for high risk
        fillColor: getRiskColor(riskCategory),
        color: isHighRisk ? '#c0392b' : '#2c3e50', // Red border for high risk
        weight: isHighRisk ? 3 : 1, // Thicker border for high risk
        opacity: 1,
        fillOpacity: 0.8
    });
    
    // Store marker reference
    if (feature.properties.station_id) {
        stationMarkers[feature.properties.station_id] = marker;
    }
    
    return marker;
},
                    onEachFeature: function(feature, layer) {
                        const props = feature.properties;
                        const popupContent = createPopupContent(props);
                        layer.bindPopup(popupContent);
                        
                        layer.on('click', function() {
                            if (props.station_id) {
                                highlightStationInSidebar(props.station_id);
                            }
                        });
                    }
                }).addTo(map);

                // Update sidebar with real data
                updateSidebarWithData(geojsonData.features);
                
                // Fit map to show all stations
                map.fitBounds(stationsLayer.getBounds());

                console.log('✅ Map loaded successfully with', geojsonData.features.length, 'stations');

            })
            .catch(error => {
                console.error('❌ Error loading GeoJSON:', error);
                alert('Error loading flood data. Using sample data for demonstration.');
                loadSampleData();
            });

        function getRiskColor(riskCategory) {
            switch(riskCategory) {
                case 'High': return '#e74c3c';
                case 'Medium': return '#f39c12';
                case 'Low': return '#f1c40f';
                case 'Very Low': return '#27ae60';
                default: return '#95a5a6';
            }
        }

        function getRiskRadius(riskCategory) {
            switch(riskCategory) {
                case 'High': return 10;
                case 'Medium': return 8;
                case 'Low': return 6;
                case 'Very Low': return 4;
                default: return 4;
            }
        }

function createPopupContent(props) {
    const isHighRisk = props.flood_risk_category === 'High' || props.flood_risk_category === 'Extreme';
    const riskColor = getRiskColor(props.flood_risk_category);
    
    return `
        <div style="min-width: 250px; padding: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid ${riskColor};">
                <div style="font-size: 16px; font-weight: 600; color: #2c3e50;">${props.station || 'Unknown Station'}</div>
                <div style="padding: 4px 8px; border-radius: 12px; color: white; font-size: 11px; font-weight: 500; background: ${riskColor}">
                    ${props.flood_risk_category || 'Unknown'}
                </div>
            </div>
            ${isHighRisk ? `
            <div style="background: #fdedec; border-left: 4px solid #e74c3c; padding: 8px; margin-bottom: 10px; border-radius: 4px;">
                <div style="color: #c0392b; font-weight: 600; font-size: 12px;">⚠️ High Flood Risk</div>
                <div style="color: #e74c3c; font-size: 11px;">Monitor this station closely</div>
            </div>
            ` : ''}
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                <div>
                    <div style="color: #7f8c8d; font-weight: 500; font-size: 12px;">River</div>
                    <div style="color: #2c3e50; font-weight: 600; font-size: 12px;">${props.river_name || 'N/A'}</div>
                </div>
                <div>
                    <div style="color: #7f8c8d; font-weight: 500; font-size: 12px;">River KM</div>
                    <div style="color: #2c3e50; font-weight: 600; font-size: 12px;">${props.river_km || 'N/A'}</div>
                </div>
                <div>
                    <div style="color: #7f8c8d; font-weight: 500; font-size: 12px;">Discharge</div>
                    <div style="color: #2c3e50; font-weight: 600; font-size: 12px;">${props.avg_discharge ? props.avg_discharge.toFixed(1) + ' m³/s' : 'N/A'}</div>
                </div>
                <div>
                    <div style="color: #7f8c8d; font-weight: 500; font-size: 12px;">Agency</div>
                    <div style="color: #2c3e50; font-weight: 600; font-size: 12px;">${props.agency || 'N/A'}</div>
                </div>
            </div>
        </div>
    `;
}

        function updateSidebarWithData(stations) {
            // Update risk counts
            const riskCounts = {
                'high': 0,
                'medium': 0,
                'low': 0,
                'very-low': 0
            };

            stations.forEach(station => {
                const risk = station.properties.flood_risk_category ? 
                    station.properties.flood_risk_category.toLowerCase().replace(' ', '-') : 'unknown';
                if (riskCounts.hasOwnProperty(risk)) {
                    riskCounts[risk]++;
                }
            });

            // Update risk overview
            document.getElementById('highRiskCount').textContent = `${riskCounts.high} stations`;
            document.getElementById('mediumRiskCount').textContent = `${riskCounts.medium} stations`;
            document.getElementById('lowRiskCount').textContent = `${riskCounts.low} stations`;
            document.getElementById('veryLowRiskCount').textContent = `${riskCounts['very-low']} stations`;

            // Update risk dots
            updateRiskDots('highRiskDots', riskCounts.high, '#e74c3c');
            updateRiskDots('mediumRiskDots', riskCounts.medium, '#f39c12');
            updateRiskDots('lowRiskDots', riskCounts.low, '#f1c40f');
            updateRiskDots('veryLowRiskDots', riskCounts['very-low'], '#27ae60');

            // Update total stations
            document.getElementById('totalStations').textContent = stations.length;

            // Populate station list
            populateStationList(stations);
        }

        function updateRiskDots(containerId, count, color) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const dotsCount = Math.min(count, 10);
            for (let i = 0; i < dotsCount; i++) {
                const dot = document.createElement('div');
                dot.className = 'risk-dot';
                dot.style.background = color;
                container.appendChild(dot);
            }
        }

        function populateStationList(stations) {
            const stationList = document.getElementById('stationList');
            stationList.innerHTML = '';

            stations.forEach(station => {
                const props = station.properties;
                const risk = props.flood_risk_category ? 
                    props.flood_risk_category.toLowerCase().replace(' ', '-') : 'unknown';
                const stationId = props.station_id || Math.random().toString(36).substr(2, 9);
                
                const item = document.createElement('div');
                item.className = `station-item ${risk}`;
                item.dataset.stationId = stationId;
                
                item.innerHTML = `
                    <div class="station-header">
                        <div class="station-name">${props.station || 'Unknown Station'}</div>
                        <div class="station-risk ${risk}">${props.flood_risk_category || 'Unknown'}</div>
                    </div>
                    <div class="station-details">
                        ${props.river_name || 'N/A'} • ${props.avg_discharge ? props.avg_discharge.toFixed(1) + ' m³/s' : 'N/A'}
                    </div>
                `;
                
                // Add click event to zoom to station
                item.addEventListener('click', function() {
                    const coords = station.geometry.coordinates;
                    map.setView([coords[1], coords[0]], 13);
                    const marker = stationMarkers[stationId];
                    if (marker) {
                        marker.openPopup();
                    }
                    highlightStationInSidebar(stationId);
                });
                
                stationList.appendChild(item);
            });
        }

        function highlightStationInSidebar(stationId) {
            // Remove highlight from all stations
            document.querySelectorAll('.station-item').forEach(item => {
                item.style.background = '';
            });
            
            // Highlight the selected station
            const selectedItem = document.querySelector(`[data-station-id="${stationId}"]`);
            if (selectedItem) {
                selectedItem.style.background = '#e8f4fd';
                selectedItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Sample data fallback
        function loadSampleData() {
            const sampleStations = [
                {
                    type: "Feature",
                    geometry: {
                        type: "Point",
                        coordinates: [13.4050, 52.5200] // Berlin
                    },
                    properties: {
                        station: "BERLIN SAMPLE",
                        river_km: 1.0,
                        agency: "SAMPLE",
                        station_id: "sample1",
                        river_name: "SPREE",
                        avg_discharge: 150.5,
                        flood_risk_category: "Medium",
                        flood_risk_score: 2
                    }
                },
                {
                    type: "Feature",
                    geometry: {
                        type: "Point",
                        coordinates: [11.5820, 48.1351] // Munich
                    },
                    properties: {
                        station: "MUNICH SAMPLE",
                        river_km: 2.5,
                        agency: "SAMPLE", 
                        station_id: "sample2",
                        river_name: "ISAR",
                        avg_discharge: 280.3,
                        flood_risk_category: "High",
                        flood_risk_score: 4
                    }
                }
            ];
            
            allStations = sampleStations;
            updateSidebarWithData(sampleStations);
        }

    </script>
</body>
</html>
